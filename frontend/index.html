<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MoneySend</title>

  <!-- Manifest for PWA -->
  <link rel="manifest" href="/static/manifest.json">
  <meta name="theme-color" content="#4CAF50">
  <link rel="icon" href="/static/icons/icon-192.png" type="image/png">

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
    }

    nav {
      background-color: #4CAF50;
      display: flex;
      justify-content: space-around;
      padding: 1em;
      flex-wrap: wrap;
    }

    nav button {
      background: none;
      border: none;
      color: white;
      font-size: 1em;
      padding: 0.5em 1em;
      cursor: pointer;
      transition: background 0.3s;
    }

    nav button:hover {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
    }

    .section {
      display: none;
      padding: 2em;
    }

    .active {
      display: block;
    }

    input, select, button {
      display: block;
      margin: 1em 0;
      padding: 0.7em;
      width: 100%;
      max-width: 400px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    button.primary {
      background-color: #4CAF50;
      color: white;
      border: none;
    }

    @media (max-width: 600px) {
      nav {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>

  <nav>
    <button onclick="showSection('home')">üè† Accueil</button>
    <button onclick="showSection('login')">üîê Connexion</button>
    <button onclick="showSection('register')">üìù Cr√©er un compte</button>
    <button onclick="showSection('wallet')">üëõ Portefeuille</button>
    <button onclick="showSection('exchange')">üí± Taux de change</button>
    <button onclick="showSection('referral')">üéÅ Parrainage</button>
    <button onclick="showSection('account')">üë§ Mon compte</button>
  </nav>

  <section id="home" class="section active">
    <h2>Bienvenue sur MoneySend</h2>
    <p>G√©rez vos envois d'argent en toute simplicit√©.</p>
  </section>

  <section id="login" class="section">
    <h2>Connexion</h2>
    <input id="username" placeholder="Nom d'utilisateur">
    <input id="password" placeholder="Mot de passe" type="password">
    <button class="primary" onclick="login()">Connexion</button>
  </section>

  <section id="register" class="section">
    <h2>Cr√©er un compte</h2>
    <input id="new-username" placeholder="Nom d'utilisateur">
    <input id="new-password" placeholder="Mot de passe" type="password">
    <button class="primary" onclick="register()">Cr√©er un compte</button>
  </section>

  <section id="wallet" class="section">
    <h2>Portefeuille</h2>
    <p>Votre solde : <strong>0.00 ‚Ç¨</strong> (fonctionnalit√© √† connecter)</p>
  </section>

  <section id="exchange" class="section">
    <h2>Taux de change</h2>
    <label>Montant :</label>
    <input type="number" id="amount" placeholder="Montant √† convertir">
    <label>De :</label>
    <select id="fromCurrency"></select>
    <label>Vers :</label>
    <select id="toCurrency"></select>
    <button class="primary" onclick="convert()">Convertir</button>
    <p id="conversionResult"></p>
  </section>

  <section id="referral" class="section">
    <h2>Parrainage</h2>
    <p>Invitez vos amis et gagnez des bonus !</p>
  </section>

  <section id="account" class="section">
    <h2>Mon compte</h2>
    <p>Nom d'utilisateur : <strong id="userDisplay">non connect√©</strong></p>
  </section>

  <script>
    let token = "";
    let exchangeRates = {
      "EUR": 1.0,
      "USD": 1.10,
      "GBP": 0.85,
      "CAD": 1.47,
      "JPY": 155.33,
      "CNY": 7.96,
      "XOF": 655.957,
      "NGN": 890.00,
      "MAD": 10.85,
      "DZD": 146.32,
      "XAF": 655.957,
      "CHF": 0.96,
      "INR": 90.12,
      "BRL": 5.30,
      "AUD": 1.63,
      "ZAR": 19.00
    };

    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    async function login() {
      const res = await fetch("/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: document.getElementById("username").value,
          password: document.getElementById("password").value
        })
      });
      const data = await res.json();
      if (data.token) {
        token = data.token;
        alert("Connect√© !");
        document.getElementById("userDisplay").innerText = document.getElementById("username").value;
        showSection('account');
      } else {
        alert("√âchec de connexion");
      }
    }

    async function register() {
      const res = await fetch("https://moneysend.onrender.com/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          username: document.getElementById("new-username").value,
          password: document.getElementById("new-password").value
        })
      });
      const data = await res.json();
      alert(data.message || "Compte cr√©√© !");
    }

    function populateCurrencies() {
      const fromSelect = document.getElementById("fromCurrency");
      const toSelect = document.getElementById("toCurrency");

      Object.keys(exchangeRates).forEach(code => {
        const opt1 = document.createElement("option");
        const opt2 = document.createElement("option");
        opt1.value = opt2.value = code;
        opt1.text = opt2.text = code;
        fromSelect.appendChild(opt1);
        toSelect.appendChild(opt2);
      });

      fromSelect.value = "EUR";
      toSelect.value = "USD";
    }

    function convert() {
      const amount = parseFloat(document.getElementById("amount").value);
      const from = document.getElementById("fromCurrency").value;
      const to = document.getElementById("toCurrency").value;

      if (!exchangeRates[from] || !exchangeRates[to] || isNaN(amount)) {
        document.getElementById("conversionResult").innerText = "Conversion invalide.";
        return;
      }

      const eurAmount = amount / exchangeRates[from]; // conversion en EUR
      const rawRate = exchangeRates[to];
      const adjustedRate = rawRate * 0.98; // 2% de commission

      const converted = eurAmount * adjustedRate;
      const withoutCommission = eurAmount * rawRate;
      const commission = withoutCommission - converted;

      document.getElementById("conversionResult").innerHTML = `
        ${amount} ${from} = <strong>${converted.toFixed(2)} ${to}</strong><br>
        <small>Taux r√©el : 1 ${from} = ${(rawRate / exchangeRates[from]).toFixed(4)} ${to}</small><br>
        <small>Taux appliqu√© (avec 2% de commission) : ${(adjustedRate / exchangeRates[from]).toFixed(4)} ${to}</small><br>
        <small>Commission pr√©lev√©e : ${commission.toFixed(2)} ${to}</small>
      `;
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/sw.js').then(reg => {
          console.log("Service Worker enregistr√© !");
        });
      });
    }

    window.onload = populateCurrencies;
  </script>
</body>
</html>
